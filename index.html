// ログ出力関数
function log(message, type = 'info') {
    const logElement = document.getElementById('log');
    const timestamp = new Date().toLocaleTimeString();
    logElement.value += `[${timestamp}] ${message}\n`;
    logElement.scrollTop = logElement.scrollHeight; // 自動で一番下までスクロール
}

// 画像URLをBase64形式に変換する関数
async function imageUrlToBase64(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`画像の取得に失敗しました: ${response.status} ${response.statusText}`);
        }
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    } catch (error) {
        log(`画像URL (${url}) のBase64変換中にエラーが発生しました: ${error.message}`, 'error');
        throw error; // エラーを再スローして、呼び出し元で処理できるようにする
    }
}

// 絵文字を追加するメイン関数
async function addEmojis(useGeneratedNames = false) {
    const token = document.getElementById('token').value.trim();
    const guildId = document.getElementById('guildId').value.trim();
    const emojiNamesInput = document.getElementById('emojiNames').value.trim();
    const emojiUrlsInput = document.getElementById('emojiUrls').value.trim();
    const delaySeconds = parseInt(document.getElementById('delay').value, 10);
    const delay = delaySeconds * 1000; // ミリ秒に変換

    if (!token || !guildId || !emojiUrlsInput) {
        log('エラー: Token、サーバーID、絵文字URLは必須です。', 'error');
        return;
    }

    const emojiNames = emojiNamesInput.split(',').map(name => name.trim()).filter(name => name !== '');
    const emojiUrls = emojiUrlsInput.split(',').map(url => url.trim()).filter(url => url !== '');

    if (emojiUrls.length === 0) {
        log('エラー: 追加する絵文字URLがありません。', 'error');
        return;
    }

    if (!useGeneratedNames && emojiNames.length > 0 && emojiNames.length !== emojiUrls.length) {
        log('エラー: 絵文字名と画像URLの数が一致しません。', 'error');
        return;
    }

    log('絵文字の追加を開始します...');

    for (let i = 0; i < emojiUrls.length; i++) {
        const url = emojiUrls[i];
        let name;

        if (useGeneratedNames) {
            name = `emoji_${Date.now()}_${i}`; // 自動生成名
        } else if (emojiNames.length > 0) {
            name = emojiNames[i];
        } else {
             // 名前指定なしで、かつuseGeneratedNamesがfalseの場合 (通常はありえないが念のため)
            name = `emoji_${Date.now()}_${i}`;
        }
        
        // 絵文字名がDiscordのルールに合っているか軽くチェック（英数字とアンダースコアのみ）
        // Discordの絵文字名は2文字以上32文字以下である必要があります。
        if (!/^[a-zA-Z0-9_]{2,32}$/.test(name)) {
            log(`エラー: 絵文字名 '${name}' は無効です。2文字以上32文字以下の英数字とアンダースコアのみ使用できます。この絵文字はスキップされます。`, 'error');
            continue; // 次の絵文字へ
        }

        log(`絵文字 '${name}' (${url}) を準備中...`);

        try {
            const base64Image = await imageUrlToBase64(url);

            // GIFのチェック (Discord APIはGIFをサポートしていますが、不安定な場合がある)
            if (base64Image.startsWith('data:image/gif') && !url.endsWith('.gif')) {
                 log(`警告: URLが.gifで終わっていませんが、GIF形式のようです。GIFの追加は不安定な場合があります。`, 'warn');
            }


            log(`絵文字 '${name}' をDiscordサーバーに追加中...`);

            const response = await fetch(`https://discord.com/api/v9/guilds/${guildId}/emojis`, {
                method: 'POST',
                headers: {
                    // ここをUser Token用に変更
                    'Authorization': token, // User Tokenを直接使用
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    image: base64Image,
                    roles: [] // 必要に応じてロールを指定
                })
            });

            const data = await response.json();

            if (response.ok) {
                log(`絵文字 '${name}' の追加に成功しました！ ID: ${data.id}`);
            } else {
                log(`絵文字 '${name}' の追加に失敗しました: ${data.message || response.statusText}`, 'error');
                if (data.code === 50035) { // Invalid Form Body
                    log(`詳細: ${JSON.stringify(data.errors)}`, 'error');
                } else if (data.code === 50013) { // Missing Permissions
                    log(`詳細: Tokenに絵文字管理権限がないか、Tokenが不正です。`, 'error');
                } else if (data.code === 40007) { // Invalid OAuth2 access token
                     log(`詳細: Tokenの有効期限が切れているか、無効なTokenです。`, 'error');
                }
            }
        } catch (error) {
            log(`絵文字 '${name}' の処理中に予期せぬエラーが発生しました: ${error.message}`, 'error');
        }

        // 最後の絵文字でなければ待機
        if (i < emojiUrls.length - 1) {
            log(`${delaySeconds}秒間待機します...`);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }

    log('全ての絵文字の追加処理が完了しました。');
}

// ボタンにイベントリスナーを設定
document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('button[onclick="addEmojis()"]').onclick = () => addEmojis(false);
    document.querySelector('button[onclick="addEmojisWithoutNames()"]').onclick = () => addEmojis(true);
});
